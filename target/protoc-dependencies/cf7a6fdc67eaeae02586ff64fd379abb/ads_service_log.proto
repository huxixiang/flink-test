syntax = "proto3";

option java_package = "com.xiaohongshu.ads.service.log.schema";
option java_outer_classname = "AdsServiceLog";


enum BidType {
  UNKNOWN_BID_TYPE = 0;
  CPD = 1;
  CPM = 2;
  CPC = 3;
  GD = 4;
  CPT = 5;
  CCPM = 6;
}

enum AdsType {
  UNKNOWN_ADS_TYPE = 0;
  BOOST_ADS = 1;
  NEW_CPD_ADS = 2;
  CAMPAIGN_ADS = 3;
  CPD_ADS = 4;
  CPD_H5_ADS = 21;
  GD_ADS = 5;
  GD_H5_ADS = 51;
  CPC_ADS = 6;
  CHIPS_ADS = 7;
}

message PacingInfo {
  int32 pacing_rate = 1;
  int32 budget = 2;
  int32 balance = 3;
}

message RankingInfo {
  double ranking_score = 1;
  double pctr = 2;
  double pctr_calibration = 3; // p_ctr 校准值
  double relevance_score = 4;
  double ces = 5;
  double ces_calibration = 6; // ces 校准值
  double pcvr = 7;

}

message TargetInfo {
  string age = 1;
  string gender = 2;
  string tags = 3;
  string location = 4; //一线城市使用dictionary表type_id=3
  string country = 5; //效果空
  string province = 6; //效果空
  string city = 7; //效果使用dictionary表type_id=6,品牌使用dictionary表type_id=9
}

message BidInfo {
  int32 bid = 1;
  int32 auction_price = 2;
  double ecpm = 3;
}

message RetrievalInfo {
  int64 dislike_ts = 1;
  int64 last_view_ts = 2;
  int64 retrieval_ts = 3;
  int64 advertiser_retrieval_ts = 4;
  int64 advertiser_last_view_ts = 5;


}

// 广告信息
message AdsInfo {
  int32 advertiser_id = 1;
  int32 ads_id = 2;
  string ads_uuid = 3;
  int32 unit_id = 4;
  int32 campaign_id = 5;
  BidType bid_type = 6;

  AdsType ads_type = 8;

  int32 advertise_target = 9; // 薯条广告的营销目标

  string position = 101;
  string match_tags = 102; //12
  PacingInfo pacing_info = 103;
  RankingInfo ranking_info = 104;
  TargetInfo target_info = 105;
  BidInfo bid_info = 106;
  RetrievalInfo retrieval_info = 108;

}

enum LogSource {
  UNKNOWN_SOURCE = 0;
  ADS_SERVICE = 1;
  DOLPHIN = 2;
  JARVIS = 3;
}

// ads-service 日志信息
message AdsServiceLogInfo {
  RequestInfo request_info = 1;
  repeated AdsInfo ads_info = 2;
  UserInfo user_info = 3;
  repeated FilterInfo filter_info = 4;
  // 海选打分
  repeated RankInfoDistribution prescreening_info = 5;
  // <bidtype, model_name>
  map<int32, string> prescreening_models = 6;
  // <bidtype, weight>
  map<int32, double> prescreening_weights = 7;
}

enum StepInfo {
  UNKNOWN_STEP = 0;
  RECALL_ADS_STEP = 1;
  PRE_RANKING_STEP = 4;
  RANKING_STEP = 7;
  POST_RANKING_STEP = 10;
  AUCTION_PRICE_STEP = 13;
  INSERT_POSITION_STEP = 16;
  FINAL_STEP = 19;
}

// 过滤信息
message FilterInfo {
  string filter_after_ids= 1;
  FilterReason filter_reason = 2;
  StepInfo step_info = 3;
  string filter_before_ids = 4;
  int64 latency = 6;
}

// 过滤原因
enum FilterReason {
  UNKNOWN_REASON = 0;

  // STEP1
  EXPANDED_KEYWORD_INDEX = 100;
  EXPANDED_KEYWORD_INDEX_2 = 101;
  RECALL_BY_PLACEMENT = 102;
  BASIC_TARGET_FILTER = 103;

  //STEP2
  TARGET_AUDIENCE_FILTER = 400;
  FREQUENCY_FILTER = 401;
  BUDGET_PACING_FILTER_FEEDS = 402; // deprecated   合并至1015
  GD_CPD_POSITION_FILTER = 403;  //BIDDING_STRATEGY_LOG replace GD_CPD_POSITION_FILTER 可以替换为403
  GOODS_STOCK_FILTER = 404;
  AFTER_PRE_RANKING = 405;
  SEND_CONTROL_FILTER = 406;  // 薯条下发数控制
  BLOOM_FILTER = 407;
  MAX_FIRST_RANKING_CAPPING = 408;
  LEADS_DEDUP_FILTER = 409;
  CPC_TRUNCATION_FILTER = 410;
  GD_CPD_FREQ_FILTER = 411;
  GD_CPD_THIRTY_MINUTES_FREQ_FILTER = 412;
  GD_FLOW_DIVIDE_FILTER = 413;
  GD_NEW_PACING_FILTER = 414;
  NEGATIVE_FEEDBACK_FILTER = 415;
  UNIQUE_ID_FILTER = 416;

  //STEP3
  UPDATE_RANKING_CAPPING = 700;
  AFTER_RANKING = 701;
  UPDATE_RANKING_CAPPING_FOR_CCPM = 702;
  RANKING_NOTE_DEDUP_FILTER = 703;
  RANKING_ADVERTISER_DEDUP_FILTER = 704;
  FINAL_RANKING_LIMIT_FILTER = 705;
  CCPC_CHIPS_RANKING_NOTE_DEDUG_FILTER = 706;
  CCPC_CHIPS_FINAL_RANKING_LIMIT_FILTER = 707;
  /**
   * gcpm笔记id去重
   */
  GCPM_RANKING_NOTE_DEDUG_FILTER = 708;
  GCPM_FINAL_RANKING_LIMIT_FILTER = 709;



  //STEP4
  BUDGET_PACING_FILTER_SEARCH = 1000; // deprecated   合并至1015
  NOTE_DEDUP_FILTER = 1001;
  MIN_CPM_FILTER = 1002;
  GD_CPD_ROUND_ROBIN_FILTER = 1003;
  GD_CPD_POSITION_FILTER_DEPRECATED = 1004;
  CAMPAIGN_DEDUP_FILTER = 1005;
  ADVERTISER_DEDUP_FILTER = 1006;
  RELEVANCE_FILTER = 1007;
  RELEVANCE_FILTER_2 = 1008;
  RELEVANCE_FILTER_GOODS1 = 1009;
  RELEVANCE_FILTER_GOODS2 = 1010;
  RELEVANCE_BLACKLIST_FILTER = 1011;
  AFTER_POST_RANKING = 1012;
  RELEVANCE_V3_FILTER1 = 1013;
  RELEVANCE_V3_FILTER2 = 1014;
  BUDGET_PACING_FILTER = 1015;  // 402 1000 合并至1015， 403被1004替代
  MATERIAL_MD5_FILTER = 1016;  // 素材MD5 去重
  RANDOM_SAMPLING_FILTER = 1017;  // 薯条随机采样
  AUTHOR_DEDUP_FILTER = 1018; // 薯条作者ID去重
  BRAKE_FILTER = 1019;  // 通用刹车过滤

  //STEP5
  AUCTION_FILTER = 1300;
  AFTER_AUCTION_PRICE = 1301;

  //STEP6
  POSITION_FILTER = 1600;
  AFTER_INSERT_POSITION = 1601;


  FINAL_RETURN = 1900;
}

// 请求信息
message RequestInfo {
  string request_id = 1; // requestId or trackId
  int64 timestamp = 2;
  AdPlacementType placement = 3; // feeds, search
  QueryInfo query_info = 4;
  string machine_list = 5; // 当前属于哪台机器
  LogSource log_source = 6;
  string env = 7;
  int32 start_position = 8;

}

// query 信息
message QueryInfo {
  string query = 1;
  // other query info, query term for exmaple
}

enum AdPlacementType {
  UNKNOWN_PLACEMENT = 0;
  EXPLORE = 1;
  SEARCH = 2;
  SEARCH_GOODS = 3;
}


enum GenderType {
  MALE = 0;
  FEMALE = 1;
  UNKNOWN_GENDER = 2;
}


enum CityTierType {
  FIRST_TIER = 0;
  NEW_FIRST_TIER = 1;
  UNKNOWN = 2;
  OTHER = 3;
  SECOND_TIER = 4;
  THIRD_TIER = 5;
  FORTH_TIER = 6;
  FIFTH_TIER = 7;
  OVERSEAS = 8;
}

message UserInfo {
  string user_id = 1;
  GenderType gender = 2;
  int32 age = 3;
  AppInfo app = 4;
  LocationInfo location = 5;
  LocationInfo gx_location = 6;
  map<string, string> experiment_info = 7; // 实验信息，需要在ads-service内部维护广告相关实验名称list
  string audienceTargetGroups = 8;
  int32 net_type = 9;
}

message DeviceInfo {
  string platform = 1;
  string manufacturer = 2;
  string device_model = 3;
}

message AppInfo {
  int32 app_first_time = 1;
  DeviceInfo device = 2;
  string register_channel = 3;
  bool new_user = 4;
  string app_build = 5;
}

message LocationInfo {
  string country = 1;
  string province = 2;
  string city = 3;
  CityTierType city_tier = 4;
}


message InsertFilterData {
  string dtm = 1;
  int32 hour = 2;
  int32 minute = 3;
  int32 advertiser_id = 4;
  int32 campaign_id = 5;
  int32 unit_id = 6;
  int32 creative_id = 7;

  string step = 14;
  string log_source = 15;
  string placement = 16;
  string query_string = 17;
  int32 bid_type = 18;
  int32 field_code = 30;
  int64 filter_cnt = 31;
  string env = 32;
  int32 advertise_target = 33;
}

message QueryDiffData {
  string dtm = 1;
  int32 hour = 2;
  string env = 3;
  string filter_reason = 4;
  string placement = 5;
  int64 latency = 6;
  int32 filter_ad_size = 7;
  string request_id = 8;
}

message QueryDiffDataV2 {
  string dtm = 1;
  int32 hour = 2;
  string env = 3;
  string filter_reason = 4;
  string placement = 5;
  int64 latency = 6;
  int32 filter_ad_size = 7;
  string request_id = 8;
  int32 before_ad_size = 9;
  string before_ad_ids = 10;
  int32 after_ad_size = 11;
  string after_ad_ids = 12;
  int32 filter_cpc_size = 13;
  string filter_cpc_ad_ids = 14;
  int32 filter_ccpm_size = 15;
  string filter_ccpm_ad_ids = 16;
  int32 filter_gd_size = 17;
  string filter_gd_ad_ids = 18;
  string user_id = 19;
  int32 current_cpc_size = 20;
  string current_cpc_ad_ids = 21;
  int32 current_ccpm_size = 22;
  string current_ccpm_ad_ids = 23;
  int32 current_gd_size = 24;
  string current_gd_ad_ids = 25;
  string before_unit_ids = 26;
  string after_unit_ids= 27;
  string before_campaign_ids = 28;
  string after_campaign_ids = 29;
  string before_adv_ids = 30;
  string after_adv_ids = 31;
}

message RankInfoDistribution {
  string request_id = 1;
  string user_id = 2;
  int64 request_ts = 3;
  int32 advertiser_id = 4;
  int32 campaign_id = 5;
  int32 unit_id = 6;
  int32 creative_id = 7;
  int32 bid_type = 8;
  string model_name = 9;
  int32 advertise_target = 10;

  double p_ctr = 31;
  double ranking_score = 32;
  int32 bid = 33;
  double original_p_ctr = 34;
  double p_ctcvr = 35;
  double ces = 36;
  double p_cfr = 37;

  bool miss_prescreening = 40;
  bool pass_prescreening = 41;
}
