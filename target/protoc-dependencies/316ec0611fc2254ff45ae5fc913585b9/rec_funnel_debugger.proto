syntax = "proto3";

option java_package = "red.sns.rec.funnel.debugger";
option java_outer_classname = "RecFunnelDebugger";
package rec.funnel.debugger;

message FunnelRequestInfo {
  string user_id = 1;
  map<string, string> parameters = 2;
}

// note被召回时相应的召回原因等当到该结构
message FunnelRecallNote {
  string source_type = 1;
  string index = 2;
  string term_field = 3;
  string term_value = 4;
  repeated TItem notes = 5;
  message TItem {
    string id = 1;
    double score = 2;
  }
}

message FunnelMantaRecall {
  string request_id = 1;
  string recall_req = 2;
  repeated FunnelRecallNote notes = 3;
  map<string, string> analysis = 4; //用于召回结果宏观的一些分析结果
  map<string, string> reserved = 5; //用于request级别自定义打点信息
}

// note特征相关的打点放到rank阶段打点返回
message FunnelRankNoteInfo {
  string id = 1;
  double rank_score = 2;
  map<string, string> features = 3; //使用的部分特征的值
  map<string, string> reserved = 4; //用于note级别自定义打点信息
  double value_model_score = 5;     //value model计算出的总分
  map<string, double> value_model_scores = 6; //value model各个行为的pxtr
}

message FunnelLambdaFirstRank {
  string request_id = 1;
  repeated FunnelRankNoteInfo notes = 2;
  map<string, string> analysis = 3; //用于粗排过程 宏观的一些分析结果
  map<string, string> reserved = 4; //用于request级别自定义打点信息的添加
}

message FunnelLambdaSecondRank {
  string request_id = 1;
  repeated FunnelRankNoteInfo output_notes = 2;
  repeated FunnelRankNoteInfo dropped_notes = 3;
  map<string, string> analysis = 4; //用于精排过程 宏观的一些分析结果
  map<string, string> reserved = 5; //用于request级别自定义打点信息的添加
}

// note相关的value model调权debug信息可以放到此处, 后续会deprecated
message FunnelValueModelNoteInfo {
  string id = 1;
  double valuemodel_score = 2;
  string reason = 3;
  map<string, string> features = 4; //使用的部分特征的值
  map<string, string> reserved = 5; //用于note级别自定义打点信息
}

//后续会deprecated
message LambdaValueModelFunnel {
  string request_id = 1;
  repeated FunnelValueModelNoteInfo output_notes = 2;  //前80名notes
  repeated FunnelValueModelNoteInfo dropped_notes = 3; //被过滤掉notes
  map<string, string> analysis = 4; //用于value model过程 宏观的一些分析结果
  map<string, string> reserved = 5; //用于request级别自定义打点信息的添加
  // note相关的value model调权debug信息可以放到此处
  message FunnelValueModelNoteInfo {
    string id = 1;
    double valuemodel_score = 2;
    string reason = 3;
    map<string, string> features = 4; //使用的部分特征的值
    map<string, string> reserved = 5; //用于note级别自定义打点信息
  }
}

message FunnelFinalRet {
  string biz = 1;
  string user_id = 2;
  string request_id = 3;
  FunnelRequestInfo rec_request = 4;                 //请求参数
  repeated FunnelPostrankNoteInfo output_notes = 5;  //最终下发note
  repeated FunnelPostrankNoteInfo dropped_notes = 6; //被过滤掉note
  map<string, string> analysis = 7; //用于postrank过程 宏观的一些分析结果
  map<string, string> reserved = 8; //用于request级别自定义打点信息的添加
  // dolphin相关的打散等debug信息可以放到此处
  message FunnelPostrankNoteInfo {
    string id = 1;
    string reason = 2;
    map<string, string> features = 3; //使用的部分特征的值
    map<string, string> reserved = 4; //用于note级别自定义打点信息
  }
}